<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <!-- Enable Windows Authentication (do this in IIS Manager as well) -->
    <security>
      <authentication>
        <windowsAuthentication enabled="true" />
        <anonymousAuthentication enabled="false" />
      </authentication>
    </security>

    <!-- ARR Reverse Proxy to Flask backend on localhost:5050 -->
    <proxy enabled="true" reverseRewriteHostInResponseHeaders="false" />

    <rewrite>
      <rules>
        <!-- Proxy all requests to the Flask app -->
        <rule name="ReverseProxyToFlask" stopProcessing="true">
          <match url="(.*)" />
          <action type="Rewrite" url="http://localhost:5050/{R:1}" />
          <serverVariables>
            <!-- Forward the authenticated user -->
            <set name="HTTP_X_REMOTE_USER" value="{REMOTE_USER}" />
            <!-- Preserve client IP information -->
            <set name="HTTP_X_FORWARDED_FOR" value="{REMOTE_ADDR}" />
            <set name="HTTP_X_FORWARDED_PROTO" value="{HTTPS}" />
            <set name="HTTP_X_FORWARDED_HOST" value="{HTTP_HOST}" />
          </serverVariables>
        </rule>

        <!-- Optional: serve static files directly if deploying /webui under IIS site root
             Otherwise the proxy rule above will handle /ui assets from Flask's static handler -->
        <rule name="StaticAssets" stopProcessing="true">
          <match url="^ui/(.*)$" />
          <action type="Rewrite" url="http://localhost:5050/ui/{R:1}" />
        </rule>
      </rules>
    </rewrite>

    <!-- Recommended headers -->
    <httpProtocol>
      <customHeaders>
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        <add name="Referrer-Policy" value="no-referrer" />
      </customHeaders>
    </httpProtocol>

  </system.webServer>
</configuration>
